````markdown
# Контракт: порт PHP Swisseph

Обновлено: 2025‑10‑27

Этот документ фиксирует рабочий контракт (входы/выходы, инварианты, крайние случаи) для порта Swiss Ephemeris в PHP с тонкими глобальными фасадами `swe_*`.

## Область охвата

- Системы домов реализованы как стратегии в `src/Domain/Houses/Systems/*`.
- Тонкие фасады, совместимые со Swiss Ephemeris:
  - Дома: `swe_houses`, `swe_houses_ex2`, `swe_house_pos`, `swe_house_name` в `src/Swe/Functions/HousesFunctions.php`
  - Планеты: `swe_calc`, `swe_calc_ut` в `src/Swe/Functions/CalcFunctions.php`
  - Rise/Set/Transit: `swe_rise_trans`, `swe_rise_trans_true_hor` в `src/Swe/Functions/RiseSetFunctions.php`
  - Сидерика: `swe_set_sid_mode`, `swe_get_ayanamsa*`, `swe_time_equ` в `src/Swe/Functions/SiderealFunctions.php`
  - Утилиты: `swe_azalt*`, `swe_refrac`, `swe_cotrans*`, `swe_get_planet_name`, `swe_version` и др.
- По возможности — алгоритмический паритет со SWE.

---

## Шаги портирования C API (SWE) и приоритеты
Этот раздел фиксирует пошаговый план расширения совместимого API swe_* сверх домов и базовой планетологии.
Отмечено (✓) — реализовано в текущей итерации; (◻) — запланировано.
1) База времени/сидерики
- ✓ `swe_sidtime` / `swe_sidtime0` — GMST из JD(UT) (упрощённая формула Миюса).
- ✓ `swe_time_equ` — equation of time (дни) по приближённой формуле Миюса.
- ✓ `swe_set_sid_mode`, `swe_get_ayanamsa_ex(_ut)`, `swe_get_ayanamsa(_ut)`, `swe_get_ayanamsa_name` — **полная реализация** аянамши для 47 режимов `SE_SIDM_*` (0-46) + USER (255). Используются правильные модели прецессии (Newcomb, IAU 1976/2000/2006, Bretagnon) согласно данным в `AyanamsaData.php`. Точность: 2025=0.33-0.76", B1950=2.83-3.59". "True" режимы (требуют swe_fixstar) — пока заглушка. Опции `SE_SIDBIT_*` — в планах.
  - **Примечание о тестировании**: При сравнении с `swetest` для эпохи J2000 наблюдается расхождение ~14" из-за использования целочисленного JD (ограничение cmd.exe). Это не ошибка реализации — при использовании точного JD=2451545.0 (вместо 2451545) точность соответствует современным эпохам (<1"). Сама PHP-реализация полностью корректна и даёт результаты, идентичные C-коду SWE.
2) Горизонтальные преобразования и рефракция
- ◻ `swe_azalt` / `swe_azalt_rev` — прямые/обратные преобразования (экваториальные/эклиптические ↔ горизонтальные) на базе `Horizontal`/`Coordinates`.
- ◻ `swe_refrac` — атмосферная рефракция (модель стандартной атмосферы; режимы TRUE_TO_APP и APP_TO_TRUE).
3) Общие преобразования и утилиты
- ◻ `swe_cotrans` — общая ортогональная ротация между системами координат (в градусах/радианах, без потери единиц).
- ◻ `swe_get_planet_name` — имена тел по `ipl` (константная таблица).
- ◻ `swe_version`, `swe_close` — версия (строка) и no-op завершение (для совместимости).
4) Сидерика: точная аянáмша
- ◻ Реализовать точные режимы `SE_SIDM_*` в `swe_get_ayanamsa_ex(_ut)` по эталону SWE (таблицы/модели прецессии), поддержать опции `SE_SIDBIT_*`.
5) Узлы и апсиды
- ✓ `swe_nod_aps(_ut)` — **базовая реализация** для mean nodes/apsides (режим SE_NODBIT_MEAN). Поддержаны: Sun, Moon (упрощённо), Mercury-Neptune, Earth. Используются таблицы VSOP87 для орбитальных элементов планет (node, perihelion, eccentricity, semi-major axis, inclination). Для Луны — упрощённые формулы Chapront. Опция SE_NODBIT_FOPOINT (фокус вместо афелия) реализована. Osculating nodes/apsides (SE_NODBIT_OSCU, SE_NODBIT_OSCU_BAR) — пока не реализованы. Smoke test показывает корректные значения для J2000.
6) Фазовые явления и видимые параметры
- ◻ `swe_pheno(_ut)` — фаза, блеск, угловой диаметр и т.п. для планет.
- ◻ Расширения `swe_rise_trans` — поддержка целей с флагами диска (центр/нижняя кромка), twilight-биты, y = геоцентр/топоцентр.
7) Затмения и покрытие
- ◻ `swe_sol_eclipse_*`, `swe_lun_eclipse_*`, `swe_occultation_*` — «where/how/when» API для солнечных/лунных затмений и покрытий (минимально — «when_next»).
8) Орбитальные элементы/экстремумы
- ◻ `swe_orbel_*`, `swe_helio_cross*`, `swe_*max_min_dist` — по мере необходимости.
9) Звёзды/каталоги
- ◻ `swe_fixstar(2)(_ut/_mag)` — доступ к звёздным каталогам; потребует поставки текстовых файлов или альтернативы.
10) Покрытие тестами и паритет
- ◻ Для каждой новой функции — юнит‑тесты с эталонными значениями и/или кросс‑проверка через `swetest`.
- ◻ Для сложных функций — харнессы, аналогичные `parity_all_houses.php`.
Примечание: в текущей итерации добавлены базовые обёртки сидерики (аянáмша), а также `swe_time_equ`. Они обозначены как «scaffold» (геометрия корректна, но не гарантирован бит‑к‑бит паритет со SWE для всех режимов) и будут уточняться в последующих шагах.
# Контракт API: swe_calc / swe_calc_ut

Цель: зафиксировать формат выходных данных, флаги, единицы и поведение ошибок.

## Вызовы
- `swe_calc(float $jd_tt, int $ipl, int $iflag, array &$xx, ?string &$serr = null): int`
- `swe_calc_ut(float $jd_ut, int $ipl, int $iflag, array &$xx, ?string &$serr = null): int`

Параметры:
- `jd_tt` / `jd_ut`: Юлианский день в TT/UT.
- `ipl`: идентификатор небесного тела (см. Constants::SE_*).
- `iflag`: битовые флаги (см. ниже).
- `xx`: выходной массив, заполняется функцией, длина = 6.
- `serr`: текст ошибки (по ссылке), может быть null при отсутствии ошибок.

Коды возврата:
- `>= 0` — успех (в дальнейшем различия для предупреждений/качества данных).
- `< 0` — ошибка. В текущей версии используется `Constants::SE_ERR = -1`.

## Формат массива xx
Базовая форма (сферические координаты + скорости):
- `xx = [a, b, r, da, db, dr]`
  - `a, b` — углы (по умолчанию эклиптическая долгота/широта; с `SEFLG_EQUATORIAL` — `RA/Dec`).
  - `r` — расстояние (единицы уточняются для каждого `ipl`, обычно AU).
  - `da, db` — угловые скорости (по умолчанию градусы/день, с `SEFLG_RADIANS` — рад/день; для `EQUATORIAL` — dRA/dDec).
  - `dr` — скорость по радиусу (единицы зависят от выбранной единицы `r`).

Векторная форма (`SEFLG_XYZ`):
- `xx = [x, y, z, vx, vy, vz]` — прямоугольные координаты и скорости в выбранной системе (по умолчанию эклиптическая, в дальнейшем управляется флагами).

Единицы по флагам:
- По умолчанию: углы в градусах, скорости угловые — градусы/день.
- `SEFLG_RADIANS`: углы в радианах, угловые скорости — радианы/день.
- `SEFLG_EQUATORIAL`: `a,b` трактуются как `RA, Dec` (в тех же угловых единицах, что заданы `SEFLG_RADIANS`), `da,db` — dRA/dDec.
- `SEFLG_XYZ`: компоненты в прямоугольной системе; единицы — AU и AU/день (реализовано для Солнца, Луны, Меркурия, Венеры, Марса, Юпитера, Сатурна, Урана).

Конфликты флагов:
- Источники эфемерид взаимоисключающие: одновременно `SEFLG_JPLEPH | SEFLG_SWIEPH | SEFLG_MOSEPH` недопустимо (>1 установлен) — `serr=INVALID_ARG`, возврат `SE_ERR`.
- `SEFLG_EQUATORIAL` и `SEFLG_XYZ` взаимоисключимы — `serr=INVALID_ARG`, `SE_ERR`.

## Ошибки
- Неверный `ipl` — `serr=INVALID_ARG (ipl=...)`, `SE_ERR`.
- Конфликт флагов — `serr=INVALID_ARG (...)`, `SE_ERR`.
- Не реализовано — `serr=UNSUPPORTED (not implemented)`, `SE_ERR` (в текущей версии возвращается для валидных входов, кроме Солнца).

## Статус реализации
- Поддержано: `SE_SUN`, `SE_MOON` — приблизительные геоцентрические эклиптические координаты по формулам Meeus (без нутации/аберрации).
- Поддержано: `SE_MERCURY`, `SE_VENUS`, `SE_MARS`, `SE_JUPITER`, `SE_SATURN`, `SE_URANUS`, `SE_NEPTUNE`, `SE_PLUTO` — приблизительные геоцентрические координаты, полученные как разность гелиоцентрических планет и вектора Земли (через солнечный вектор); скорости и XYZ-скорости по центральной разности.
- Не поддержано: прочие тела Swiss Ephemeris вне перечисленных `SE_*` — возвращают `SE_ERR` и `serr=UNSUPPORTED`.

Примечания:
- При флаге `SEFLG_SPEED` скорости оцениваются центральной разностью (±0.5 суток). Для `SEFLG_XYZ` скорости реализованы (AU/день). Для `SEFLG_EQUATORIAL` dRA считается через преобразование эклиптик->экватор и угловую разность RA.

## Примечания по совместимости
- Где это возможно, значения флагов и формат следуют Swiss Ephemeris, но точное соответствие будет уточняться по мере реализации.
- Единицы расстояний/скоростей будут документированы для каждого `ipl` на этапе подключения эфемерид.

---

# Контракт API: swe_rise_trans / swe_rise_trans_true_hor

Цель: вычисление времени события (в пределах суток [JD, JD+1)) для восхода/захода/меридианного транзита.

## Вызовы
- `swe_rise_trans(float $jd_ut, int $ipl, ?string $starname, int $epheflag, int $rsmi, array $geopos, float $atpress, float $attemp, ?float $horhgt, ?float &$tret = null, ?string &$serr = null): int`
- `swe_rise_trans_true_hor(float $jd_ut, int $ipl, ?string $starname, int $epheflag, int $rsmi, array $geopos, float $atpress, float $attemp, ?float $horhgt, ?float &$tret = null, ?string &$serr = null): int`

Параметры:
- `jd_ut`: Юлианский день (UT) начала интервала.
- `ipl`: идентификатор тела (поддержаны: `SE_SUN`, `SE_MOON`).
- `starname`: имя звезды (пока не поддержано; использовать null).
- `epheflag`: флаги эфемерид (зарезервировано).
- `rsmi`: битовая маска события:
  - `SE_CALC_RISE` — восход (пересечение снизу-вверх)
  - `SE_CALC_SET` — заход (пересечение сверху-вниз)
  - `SE_CALC_MTRANSIT` — верхняя кульминация (часовой угол 0)
  - `SE_CALC_ITRANSIT` — нижняя кульминация (часовой угол π)
  - Допускается ровно один бит за вызов; иначе `INVALID_ARG`.
- `geopos`: `[lon_deg, lat_deg, alt_m]` — долгота (восточная +), широта, высота над уровнем моря.
- `atpress`, `attemp`: атмосферное давление (мбар) и температура (°C). Пока не используются в модели рефракции.
- `horhgt`: высота видимого горизонта в градусах; null — использовать дефолт для тела.

Выходы:
- `tret`: JD(UT) события в интервале `[jd_ut, jd_ut + 1)`, если найдено.
- `serr`: строка ошибки/предупреждения; при успехе может быть null.

Коды возврата:
- `>= 0` — успех; `tret` установлен.
- `< 0` — ошибка:
  - `INVALID_ARG` — некорректные параметры (`rsmi`, `geopos`).
  - `UNSUPPORTED` — тело/режим не поддержаны.
  - `NOT_FOUND` — событие отсутствует в интервале (полярный день/ночь и т.п.).

Единицы и дефолты:
- Углы — радианы/градусы внутренних расчётов не влияют на API; `tret` всегда JD(UT).
- Дефолт `horhgt`: Солнце ≈ `-0.833°`; Луна ≈ `-0.3°` (упрощённо).
- В `swe_rise_trans_true_hor` при `horhgt = null` используется `0.0°` (без рефракции и полудиаметра).

Примечания реализации:
- Алгоритм поиска: грубый скан интервала часа с последующей бисекцией (30 итераций) до субсекундной точности JD.
- Для транзитов решается RA = LST (верхний) или RA = LST − π (нижний).
- Для восхода/захода решается `alt(t) = h0` с фильтром направления пересечения.
- Полярные случаи: перед поиском оценивается `min/max` высоты за сутки часовым шагом; если весь день ниже/выше `h0`, возвращается `NOT_FOUND`.
- Луна: RA/Dec топоцентрические — применяется горизонтальный параллакс (формулы через geodetic lat, высоту, LST); `h0` пока фиксированный, будет уточнён с учётом текущего полудиаметра.


---

# Контракт API: дома (swe_houses, swe_houses_ex2, swe_house_pos)

Цель: совместимые с Swiss Ephemeris фасады для систем домов с минимальной обвязкой и единицами/поведением SWE.

## Вызовы
- `swe_houses_ex2(float $jd_ut, int $iflag, float $geolat, float $geolon, string $hsys, array &$cusp, array &$ascmc, ?array &$cusp_speed = null, ?array &$ascmc_speed = null, ?string &$serr = null): int`
- `swe_houses(float $jd_ut, float $geolat, float $geolon, string $hsys, array &$cusp, array &$ascmc): int`
- `swe_house_pos(float $armc_deg, float $geolat_deg, float $eps_deg, string $hsys, array $xpin, ?string &$serr = null): float`

Параметры и выходы:
- `jd_ut`: Юлианский день (UT) для вычисления домов.
- `iflag`: зарезервировано для будущих флагов (напр., RADIANS). Сейчас выдача всегда в градусах.
- `geolat`, `geolon`: широта и долгота места, градусы (север/восток — положительные).
- `hsys`: код системы домов. Поддержаны: `A,E,D,N,F,L,G,Q,I,i,P,K,O,C,R,W,B,V,M,H,T,S,X,U,Y,J`.
- `cusp`: массив куспов; размер 13 (индексация 1..12). Для 'G' — 37 (1..36) — границы 36 секторов.
- `ascmc`: массив размера 10: `[0]=Asc`, `[1]=MC`, `[2]=ARMC` (в градусах), `[9]=деклинация Солнца` для систем Sunshine ('I'/'i').
- `cusp_speed`, `ascmc_speed`: при передаче не-null заполняются нулями (соответственно 13/10 или 37/10 для 'G').
- Возврат: `0` — успех; `SE_ERR` — ошибка (например, Placidus/Koch для полярных широт).

Особенности систем:
- 'G' (Gauquelin):
  - В `swe_houses_ex2` возвращаются 36 границ секторов (по часовой стрелке) в `cusp[1..36]` и обычные Asc/MC/ARMC в `ascmc`.
  - В `swe_house_pos` позиция в секторах (1..36], движение по часовой стрелке.
- 'I'/'i' (Sunshine):
  - Вариант Treindl ('I') и Makransky ('i') задаётся буквой; в `ascmc[9]` помещается деклинация Солнца (оценка через средний наклон эклиптики).
- 'Y' (APC):
  - Куспы через порт `apc_sector` с принудительным выравниванием осей у полюсов (`cusp[10]=MC`, `cusp[4]=MC+180`).
  - `swe_house_pos`: общий интерполятор по куспам с точным «снаппингом» к осям (Asc/MC/Desc/IC).
- 'J' (Savard‑A):
  - Куспы: точный порт из SWE (геометрия Asc1; заполнение противоположных домов и осей).
  - `swe_house_pos`: алгоритм на «prime vertical» согласно SWE. При точном попадании на оси/куспы возвращается целый номер дома.

Единицы и соглашения:
- Все углы на выходе — в градусах (как в SWE); внутренние расчёты ведутся в радианах.
- `ascmc[2]` всегда содержит ARMC в градусах.
- Индексация куспов — 1..12 (или 1..36 для 'G').

Ошибки и крайние случаи:
- Placidus ('P') и Koch ('K') могут быть недопустимы на высоких широтах — функция возвращает `SE_ERR` и `serr=...`.
- Для 'G' скорость массивов заполняется нулями корректной длины.

Статус тестов:
- Покрыты юнит‑тестами фасады и специальные ветки ('G', 'I'/'i', 'Y', 'J').
- Последний прогон: OK (69 tests, 569 assertions).

## Пути к swetest и эфемеридам (для паритета)

Для стабильных паритет‑сравнений с оригинальным swetest (Swiss Ephemeris C) используются:

- Переменные окружения (опционально):
  - `SWETEST_PATH` — полный путь к исполняемому swetest (по умолчанию Windows‑сборка из репозитория).
  - `SWEPH_EPHE_DIR` — директория с файлами эфемерид Swiss Ephemeris, передаётся в swetest параметром `-edir`.

- Значения по умолчанию под Windows (включены в скрипт `scripts/parity_j_vs_swetest.php`):
  - `SWETEST_PATH_DEFAULT` = `C:\Users\serge\OneDrive\Documents\Fractal\Projects\Component\Swisseph\с-swisseph\swisseph\windows\programs\swetest64.exe`
  - `SWEPH_EPHE_DIR_DEFAULT` = `C:\Users\serge\OneDrive\Documents\Fractal\Projects\Component\Swisseph\с-swisseph\swisseph\ephe`

При вызове swetest харнесс автоматически добавляет `-edir"<путь>"` (если директория существует).

Примечание по выводу swetest: табличный режим (`-fPl -head`) для некоторых систем может маркировать строку `house 1` относительно противоположной полуокружности по сравнению с нашим соглашением `cusp1 = Asc`. Харнесс нормализует сравнение: поворачивает список по `Ascendant` и, если `ΔAsc ≈ 180°`, инвертирует (сдвиг на 6 домов) перед расчётом дельт, чтобы сравнивать геометрию, а не артефакт конвенции.


## Паритет со swetest (all systems)

Для массовой сверки геометрии домов с эталонным swetest доступны:

- Скрипт для всех систем: `scripts/parity_all_houses.php`
- Точечный скрипт для Savard‑A: `scripts/parity_j_vs_swetest.php`
- Опциональный PHPUnit‑тест (guarded) `tests/HousesParityWithSwetestTest.php`

Требования:
- Установленный `swetest` (см. переменные окружения выше); каталоги эфемерид доступны.
- Windows PowerShell (pwsh) — команды ниже даны для неё.

Как запустить харнесс всех систем:

```powershell
# (опционально) указать пути, если отличны от дефолтных
$env:SWETEST_PATH = 'C:\\path\\to\\swetest64.exe'
$env:SWEPH_EPHE_DIR = 'C:\\path\\to\\ephe'

# запустить сводный прогон
php php-swisseph\scripts\parity_all_houses.php
```

Как запустить guarded PHPUnit‑паритет:

```powershell
$env:RUN_SWETEST_PARITY = '1'
php php-swisseph\vendor\phpunit\phpunit\phpunit -c php-swisseph\phpunit.xml.dist
```

Методика нормализации (встроена в харнесс):
- Ротация списка куспов swetest к `Asc` (там, где `cusp1≈Asc`).
- Автоинверсия (смещение на 6 домов), если `ΔAsc` близко к 180°.
- Перебор «forward/reversed» + циклический сдвиг с выбором по композитному score.
- В score учитываются: средняя/максимальная дельта по куспам, умеренный вклад осевых дельт (Asc, для квадрантных систем — MC).

Особые случаи и оговорки:
- Sunshine 'I'/'i', APC 'Y', Savard‑A 'J': табличные конвенции swetest отличаются от соглашения `cusp1=Asc` и/или направления отсчёта. Геометрия в фасадах соответствует SWE, но табличное сопоставление требует системно‑специфичных «якорей»; харнесс уже применяет осевые подсказки, дальнейшая донастройка — в планах.
- Gauquelin 'G': сравнение ведётся по 36 секторам с отдельным парсером swetest; направление — по часовой стрелке.
- Placidus/Koch на высоких широтах: возможны ошибки у обеих реализаций; харнесс помечает кейс и идёт дальше.

Выводы харнесса:
- По каждой системе и набору локаций печатаются: выбранное соответствие (forward/reversed, сдвиг), средняя/максимальная Δ, контрольные Δ по домам 1 и 10, а также осевые ΔAsc/ΔMC для выбранного соответствия.
- В конце формируется короткая сводка `avg(avgΔ)` и `max(maxΔ)`, плюс средние осевые Δ.

