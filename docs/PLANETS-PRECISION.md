# План повышения точности планет (без упрощений)

Цель: сохранить архитектурную последовательность преобразований (световое время → геоцентр → дефлекция Солнца → годичная аберрация → прецессия/двойная нутация с матрицей скоростей → унифицированный обликвитет), и улучшать первичные эфемериды тел.

## 1) Статус на 2025-11-08
- Луна: субарксекундная геоцентрическая экваториальная точность (RA ~0.000", Dec ~0.001").
- Планеты: паритет с C (swetest и собственный C-harness) в пределах:
  - Углы ≤ 0.01° (типично ~0.005° по эклиптике, ≤0.001° по экватору).
  - Дистанция ≤ 2e-5 AU.
- Проверки:
  - Saturn/Jupiter: `tests/SaturnAccuracyTest.php`, `tests/JupiterAccuracyTest.php` (ссылки от swetest).
  - C-харнесс: `tests/planet_harness.c` + `tests/ParityPlanetWithCHarnessTest.php` (прямое сравнение PHP vs C).
  - Скан остаточных: `tests/PlanetResidualScan.php` (сетка дат для всех классических планет).

## 2) Принципы (без компромиссов)
- Никаких локальных формул обликвитета/нутации: только централизованный кэш `SwedState->ensureNutation()`.
- Сохранение порядка операций как в C (`sweph.c`/`swemplan.c`):
  - Двухитерационная поправка светового времени по геоцентрической дистанции.
  - Геоцентр до оптических эффектов (если не HELCTR/BARYCTR).
  - Дефлекция Солнца (релятивистская), годичная аберрация (Лоренц-коррекция).
  - Прецессия + двойная нутация (вторая – матрица скоростей на t - Δt_nut).
  - Единый обликвитет (J2000/текущий) из `EpsilonData`.

## 3) Следующие шаги по эфемеридам
- VSOP87: интегрировать для внутренних планет (Mercury–Mars) и внешних (Jupiter–Neptune):
  - Поставить минимальный слой над расчётом VSOP координат (гелиоцентрические экл. J2000),
  - Подключить существующий transform-пайплайн без изменений порядка.
  - Сохранить/добавить кеширование серий и промежуточных векторов.
- JPL DE (опционально):
  - Разработать адаптер чтения бинарных эфемерид (SPK/NAIF или предготовленные сегменты),
  - Нормализовать вектора в формат нашего конвейера (единицы/системы отсчёта),
  - Проверить легальную сторону распространения файлов.

## 4) Тестовые критерии
- Углы: ≤ 0.005° (цель), ≤ 0.01° (жёсткий порог)
- Дистанция: ≤ 1e-5 AU (цель), ≤ 2e-5 AU (жёсткий порог)
- Для каждой планеты добавить reference-набор (swetest и C-харнесс);
  - Сетка: каждые ~10 лет в интервале 1950–2070 (расширяем при необходимости).

## 5) Инструменты и документы
- Генерация ссылок: `tests/generate_planet_refs.php` (универсальный)
- Сканирование остаточных: `tests/PlanetResidualScan.php`
- Проверка паритета: `tests/ParityPlanetWithCHarnessTest.php`, `tests/planet_harness.c`
- Обликвитет/нутация: `docs/PRECESSION-MODELS.md`

## 6) Риски и внимание к деталям
- Radians/deg и флаги форматов (`SEFLG_RADIANS`, `SEFLG_EQUATORIAL`, `SEFLG_XYZ`) — строго отслеживать интерфейс и единицы.
- Топоцентрические случаи — отделить от геоцентрических, учитывать параллакс (см. Луна).
- Итерации светового времени и порядок преобразований не менять.

## 7) Дальнейшие улучшения
- Расширить C-харнесс для вывода скоростей и XYZ (для доп.проверок разностных производных).
- Добавить вариант сканера с топоцентрическими координатами и высотами.
- Проложить путь к полному JPL-паритету с JSON-дампом через C-обертку.
