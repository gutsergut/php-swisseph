# VSOP87 Ingestion Plan (Venus..Neptune)

Цель: поэтапно загрузить полные рядовые коэффициенты VSOP87 (вариант VSOP87D — гелиоцентрические эллиптические координаты L,B,R) для планет Venus, Earth (для внутренней проверки, хотя Earth напрямую не нужна в стратегиях), Mars, Jupiter, Saturn, Uranus, Neptune, с сохранением точного формата и порядка вычислений без упрощений.

## 1. Файловая структура

```
php-swisseph/
  src/
  data/
    vsop87/
      mercury/        (уже есть)
        L0.json .. L5.json
        B0.json .. B5.json
        R0.json .. R5.json
      venus/
        L0.json .. L5.json
        B0.json .. B5.json
        R0.json .. R5.json
      earth/
        L0.json .. L5.json
        B0.json .. B5.json
        R0.json .. R5.json
      mars/
        L0.json .. L5.json
        B0.json .. B5.json
        R0.json .. R5.json
      jupiter/
        L0.json .. L5.json
        B0.json .. B5.json
        R0.json .. R5.json
      saturn/
        L0.json .. L5.json
        B0.json .. B5.json
        R0.json .. R5.json
      uranus/
        L0.json .. L5.json
        B0.json .. B5.json
        R0.json .. R5.json
      neptune/
        L0.json .. L5.json
        B0.json .. B5.json
        R0.json .. R5.json
```

Каждый Xn.json — массив объектов:

```jsonc
[
  { "A": 0.3870983098, "B": 0.0, "C": 0.0 },
  { "A": 0.0000003715, "B": 4.659588860, "C": 104351.612566 },
  ...
]
```

Где:
- A, B, C — коэффициенты VSOP87 (единицы как в оригинале: L,B — радианы в вычислении, R — а.е.).
- Файлы содержат только соответствующую степень t^n (t = (JD_TT − 2451545.0) / 365250.0).

## 2. Источник данных и контроль

Оригинальные коэффициенты берутся из официального релиза VSOP87 (табличные файлы). Преобразование в JSON делается скриптом (будет добавлен отдельно):

1. Парсим секцию для требуемой планеты и серии (L,B,R).
2. Группируем по степени n → формируем файл Xn.json.
3. Сохраняем в scientific/decimal без лишнего округления, чтобы не терять разрядность.
4. Проверка: обратный пересчёт L,B,R для нескольких дат (J2000, ±1000, ±10000) — расхождение с эталонным VSOP87 < 1e-12 рад (углы) / < 1e-12 а.е. (радиусы).

## 3. Порядок внедрения

1. Venus → минимальная правка Vsop87Strategy (switch-case) + тест паритета (аналог Mercury).
2. Mars.
3. Jupiter (проверка больших наборов терминов — важно профилировать время загрузки).
4. Saturn.
5. Uranus.
6. Neptune.

Earth: опционально (для внутренней валидации/кросс‑проверки Земли). В обычном вычислении геоцентрических координат для других планет Земля берётся из Swiss Ephemeris.

## 4. Производительность и кеширование

- Ввести статический кеш в VsopSegmentedLoader: `static array $cache = [planetKey => model]`.
- Позже: lazy preloading при первом использовании флага SEFLG_VSOP87.
- Опционально: сборка PHP-файлов с массивами для продакшена вместо json_decode.

## 5. Тестирование

Для каждой планеты добавить тест `PlanetVsopStrategyParityTest`:
- Сравнение фасада и прямой стратегии (как для Mercury).
- Сравнение против эталонных значений из прямого пересчёта таблиц (генератор создаст `tests/vsop_refs/<planet>.json`).
- Диапазон дат: J2000 ± {0, 1000, 5000, 20000} дней.
- Допуски: 1e-11 рад для L,B; 1e-11 а.е. для R; после упаковки — соответствующие преобразования в пределах плавающей погрешности (< 1e-12 относ.).

## 6. Переход к общему пайплайну

После полного ingestion: Vsop87Strategy будет возвращать barycentric ecliptic J2000 (xyz+v), а преобразования перенесём в PlanetApparentPipeline.

## 7. Контроль целостности

Checklist:
- Все L0..L5, B0..B5, R0..R5 присутствуют (минимум L0/B0/R0).
- json_decode без ошибок.
- Паритет фасада/стратегии < 1e-12 (в исходном пространстве).
- Сравнение с эталоном VSOP87: углы < 1e-11 рад, радиус < 1e-11 а.е.

## 8. Ловушки

- Потеря точности при сериализации JSON → не округлять лишнего.
- Перепутанные степени t → проверить соответствие Xn.json степени n.
- Нормализация долготы выполнять после суммирования ряда.
- Jupiter/Saturn: большой объём терминов — обязателен кеш модели.

## 9. Следующие шаги

- Реализовать кеш в VsopSegmentedLoader.
- Генератор JSON из таблиц (`scripts/build_vsop87.php`).
- Добавить Venus в Vsop87Strategy + тесты.
- Повторить для остальных планет.
